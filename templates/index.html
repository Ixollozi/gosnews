<!DOCTYPE html>
{% load i18n %}
{% load static %}
<html lang="{{ LANGUAGE_CODE }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% trans "Kambag'allikni qisqartirish" %}</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}?v={% now 'U' %}">
</head>
<body>
{% csrf_token %}
<!-- Header -->
<header class="header">
    <div class="logo">
        <a href="{% url 'home' %}"><img src="{% static 'images/logo.svg' %}" alt="logo"></a>
    </div>

    <!-- Desktop Navigation -->
    <nav class="navbar" id="navbar">
        <a href="{% url 'home' %}" data-page="bosh-sahifa" class="active">{% trans "Bosh sahifa" %}</a>
        <div class="dropdown" id="dropdown-jangarma">
            <span>{% trans "Jang'arma" %}</span>
            <i class="arrow-down"></i>
            <div class="dropdown-menu">
                <a href="#footer">{% trans "Biz haqimizda" %}</a>
                <a href="leaders">{% trans "Rahbariyat" %}</a>
                <a href="guide/loan">{% trans "Suddan" %}</a>
                <a href="guide/subsidy">{% trans "Subsidiya" %}</a>
                <a href="guide/grant">{% trans "Grantlar" %}</a>
            </div>
        </div>
        <a href="#ariza" data-page="ariza">{% trans "Ariza qoldirish" %}</a>
        <a href="#news" data-page="yangiliklar">{% trans "Yangiliklar" %}</a>
        <a href="#hududlar" data-page="hududlar">{% trans "Hududlar" %}</a>
        <a href="#mahalla" data-page="mahalla">{% trans "online.mahalla" %}</a>
    </nav>

    <!-- Header Right Section -->
    <div class="header-right">
        <div class="hamburger" id="hamburger">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <!-- Language selector -->
        <div class="language-selector" id="language-selector">
            <img src="{% static 'images/global-icon.svg' %}" alt="world-icon">
            <span id="current-language">{% get_language_info for LANGUAGE_CODE as lang %}{{ lang.code|upper|slice:":3" }}</span>
            <i class="arrow-down"></i>
            <div class="language-menu">
                <a href="#" data-lang="uz" onclick="changeLanguage('uz'); return false;">{% trans "O'zbek" %}</a>
                <a href="#" data-lang="ru" onclick="changeLanguage('ru'); return false;">{% trans "Русский" %}</a>
                <a href="#" data-lang="kaa" onclick="changeLanguage('kaa'); return false;">{% trans "Karakalpak" %}</a>
            </div>
        </div>
        <div class="search">
            <button>
                <img src="{% static 'images/search-icon.svg' %}" alt="search-icon" class="search-icon">
                <span>{% trans "Qidiruv" %}</span>
            </button>
        </div>
    </div>

    <!-- Mobile Menu -->
    <nav class="mobile-menu" id="mobile-menu">
        <a href="{% url 'home' %}" data-page="bosh-sahifa" class="active">{% trans "Bosh sahifa" %}</a>
        <div class="mobile-dropdown">
            <div class="mobile-dropdown-header" id="mobile-dropdown-header">
                <span>{% trans "Jang'arma" %}</span>
                <i class="arrow-down"></i>
            </div>
            <div class="mobile-dropdown-content" id="mobile-dropdown-content">
                <a href="#">{% trans "Biz haqimizda" %}</a>
                <a href="leaders">{% trans "Rahbariyat" %}</a>
                <a href="guide/loan">{% trans "Suddan" %}</a>
                <a href="guide/subsidy">{% trans "Subsidiya" %}</a>
                <a href="guide/grant">{% trans "Grantlar" %}</a>
            </div>
        </div>
        <a href="#ariza" data-page="ariza">{% trans "Ariza qoldirish" %}</a>
        <a href="#news" data-page="yangiliklar">{% trans "Yangiliklar" %}</a>
        <a href="#hududlar" data-page="hududlar">{% trans "Hududlar" %}</a>
        <a href="#mahalla" data-page="mahalla">{% trans "online.mahalla" %}</a>
    </nav>
</header>

<!-- Main Content -->
<main class="main-content">
    <!-- Hero Section -->
    <div class="hero-section">
        <img src="{% static 'images/image content.png' %}" alt="hero-image">
        <div class="overlay"></div>
        <div class="hero-text">
            <h1>{% trans "Yashash sharoitlarini yaxshilash – barchamiz uchun!" %}</h1>
            <p>{% trans "Kambag'allikni kamaytirish va fuqarolarimizni qo'llab-quvvatlash yo'lida davlatimiz barqaror chora-tadbirlarni amalga oshirmoqda." %}</p>
            <div class="buttons">
                <button class="btn btn-secondary"><a href="#learners">{% trans "Dasturlar bilan tanishing" %} <i class="arrow-right"></i></a></button>
            </div>
        </div>
    </div>

    {% comment %} <!-- Application Section -->
    <div class="headers" id="ariza">{% trans "Ariza qoldirish" %}</div>
    <div class="fade-line"></div>
    <!-- Content for applications can be added here if needed --> {% endcomment %}

    <!-- News Section -->
    <div class="headers" id="news">{% trans "Yangiliklar" %}</div>
    <div class="fade-line"></div>
    <div class="news-container">
        {% for news_item in news %}
        <a class="news-card" href="{% url 'news_detail' news_id=news_item.news.id %}">
            <img src="{{ news_item.image.url }}" alt="news-image">
            <div class="news-content">
                <h2>{{ news_item.title }}</h2>
                <p>{{ news_item.short_description }}</p>
                <span class="news-date">
                    {% if news_item.category %}
                        <span class="news-category">{{ news_item.category.name }}</span>
                        <span class="news-time">{{ news_item.news.created_at|date:"d M, H:i" }}</span>
                    {% endif %}
                    
                </span>
            </div>
        </a>
        {% empty %}
        <div class="news-card">
            <img src="{% static 'images/image content.png' %}" alt="news-image">
            <div class="news-content">
                <h2>{% trans "Toshkent shahar Kambag'allikni qisqartirish va bandlik bosqarmasiga yangi boshliq tayinlandi" %}</h2>
                <p>{% trans "Mazkur turinova Mazkur bank Toshkent shahar bosh boshqarmasi boshlig'i o'rinbosari tayinlandi." %}</p>
                <span class="news-date">
                    <span class="news-category">{% trans "Tayinlov" %}</span>:
                    <span class="news-time">{% trans "21 iyul, 12:21" %}</span>
                </span>
            </div>
        </div>
        <div class="news-card">
            <img src="{% static 'images/image 6.png' %}" alt="news-image">
            <div class="news-content">
                <h2>{% trans "Samarkand viloyatida yangi ijtimoiy loyihalar boshlab olindi" %}</h2>
                <p>{% trans "Ushbu loyihalar yoshlar imkoniyatlarini kengaytirishga qaratilgan." %}</p>
                <span class="news-date">
                    <span class="news-category">{% trans "Loyihalar" %}</span>:
                    <span class="news-time">{% trans "10 avgust, 09:45" %}</span>
                </span>
            </div>
        </div>
        <div class="news-card">
            <img src="{% static 'images/image 6.png' %}" alt="news-image">
            <div class="news-content">
                <h2>{% trans "Buxoro shahrida yangi sport kompleksi ochildi" %}</h2>
                <p>{% trans "Kompleks hududi sport musobaqalari o'tkazish uchun mo'ljallangan." %}</p>
                <span class="news-date">
                    <span class="news-category">{% trans "Ochilish tadbiri" %}</span>:
                    <span class="news-time">{% trans "5 sentabr, 15:30" %}</span>
                </span>
            </div>
        </div>
        {% endfor %}
    </div>
    <a href="{% url 'all_news' %}" class="see-more-btn">{% trans "Davom etish " %}</a>

    <!-- Learners Section -->
    <div class="headers" id="learners">{% trans "Dasturlari bilan tanishing" %}</div>
    <div class="fade-line"></div>
    <div class="lern-container">
        {% for guide_choice in guide_choices %}
        <div class="lern-card">
            <a href="{% url 'guide' guide_type=guide_choice.guide.guide_type %}">
                <img src="{{ guide_choice.guide.preview_url }}" alt="lern-image">
                <div class="lern-content">
                    <h2>
                        {% if guide_choice.short_title %}
                            {{ guide_choice.short_title }}
                        {% else %}
                            {{ guide_choice.title }}
                        {% endif %}
                    </h2>
                    <p>
                        {% if guide_choice.short_description %}
                            {{ guide_choice.short_description }}
                        {% else %}
                            {{ guide_choice.description|truncatewords:20 }}
                        {% endif %}
                    </p>
                    <span class="guide-type-badge" data-type="{{ guide_choice.guide.guide_type }}">
                        {{ guide_choice.guide.get_guide_type_display }}
                    </span>
                </div>
            </a>
        </div>
        {% empty %}
        <div class="lern-card">
            <a href="#">
                <img src="{% static 'images/image content.png' %}" alt="lern-image">
                <div class="lern-content">
                    <h2>{% trans "Dasturlar haqida ma'lumot" %}</h2>
                    <p>{% trans "Kambag'allikni qisqartirish dasturlari bilan tanishing" %}</p>
                </div>
            </a>
        </div>
        {% endfor %}
    </div>

    <!-- Hududlar Section -->
    <div class="headers" id="hududlar">{% trans "Hududlar" %}</div>
    <div class="fade-line"></div>
    <div class="hero-section">
        <div class="content">
            <!-- Mobile Dropdown -->
            <div class="mobile-region-dropdown">
                <select id="region-select">
                    {% for leader in leaders_list %}
                    <option
                        value="{{ leader.region|lower }}"
                        data-name="{{ leader.leader_name|escapejs }}"
                        data-position="{{ leader.leader_position|escapejs }}"
                        data-image="{{ leader.leader_image.url }}"
                        data-mail="{{ leader.leader_mail|default_if_none:'' }}"
                        data-phone="{{ leader.leader_phone|default_if_none:'' }}"
                        data-region-embed="{{ leader.region_embed|default:leader.region_link }}"
                    >
                        {{ leader.region }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Sidebar (Desktop) -->
            <div class="sidebar">
                {% for leader in leaders_list %}
                <button
                    class="region"
                    data-region="{{ leader.region|lower }}"
                    data-name="{{ leader.leader_name|escapejs }}"
                    data-position="{{ leader.leader_position|escapejs }}"
                    data-image="{{ leader.leader_image.url }}"
                    data-mail="{{ leader.leader_mail|default_if_none:'' }}"
                    data-phone="{{ leader.leader_phone|default_if_none:'' }}"
                    data-region-embed="{{ leader.region_embed|default:leader.region_link }}"
                >
                    {{ leader.region }}
                </button>
                {% endfor %}
            </div>

            <!-- Map & Contact Section -->
            <div class="map-section">
                <iframe id="region-map" width="100%" height="450" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>

                <div class="contact-card">
                    {% if current_leader %}
                        <img id="leader-image" src="{{ current_leader.leader_image.url }}" alt="profile" class="profile-pic">
                        <div class="contact-info">
                            <h3 id="leader-name">{{ current_leader.leader_name }}</h3>
                            <p id="leader-position">{{ current_leader.leader_position }}</p>
                            {% if current_leader.leader_mail %}
                                <p id="leader-mail"><a href="mailto:{{ current_leader.leader_mail }}">{{ current_leader.leader_mail }}</a></p>
                            {% else %}
                                <p id="leader-mail"></p>
                            {% endif %}
                            {% if current_leader.leader_phone %}
                                <p id="leader-phone"><a id="leader-phone-a" href="tel:{{ current_leader.leader_phone }}">{{ current_leader.leader_phone }}</a></p>
                            {% else %}
                                <p id="leader-phone"></p>
                            {% endif %}
                        </div>
                    {% else %}
                        <img id="leader-image" src="{% static 'images/image 1.png' %}" alt="profile" class="profile-pic">
                        <div class="contact-info">
                            <h3 id="leader-name">Alisher Alisherovich</h3>
                            <p id="leader-position"></p>
                            <p id="leader-mail"></p>
                            <p id="leader-phone"></p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Partners Section -->
    <div class="headers" id="partners">{% trans "Hamkorlarimiz" %}</div>
    <div class="fade-line"></div>
    <section class="partners-section">
        <div class="partners-grid">
            <div class="partner-card">
                {% for partner in partners %}
                <div class="partner-image">
                    <img src="{{ partner.image.url }}" alt="partner-logo">
                </div>
                <p>{{ partner.name }}</p>
                {% endfor %}
            </div>
        </div>
    </section>

    <!-- Payment section -->
    <div class="headers" id="payment">{% trans "To'lovlar" %}</div>
    <div class="fade-line"></div>
    <section class="partners-section">
        <div class="partners-grid">
            <div class="partner-card">
                <div class="partner-image">
                    <img src="{% static 'images/paymelogo.png' %}" alt="payme-logo">
                </div>
            </div>
            <div class="partner-card">
                <div class="partner-image">
                    <img src="{% static 'images/clicklogo.png' %}" alt="click-logo">
                </div>
            </div>
            <div class="partner-card">
                <div class="partner-image">
                    <img src="{% static 'images/uzumbanklogo.png' %}" alt="uzum-logo">
                </div>
            </div>
            <div class="partner-card">
                <div class="partner-image">
                    <img src="{% static 'images/sqblogo.png' %}" alt="sqb-logo">
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer" id="footer">
        <img src="{% static 'images/logo.svg' %}" alt="Footer Logo">
        <div class="footer-left">
            <ul class="footer-links">
                <li><a href="#">{% trans "Asosiy" %}</a></li>
                <li><a href="#">{% trans "Jang'arma haqida" %}</a></li>
                <li><a href="#">{% trans "Arizalar qoldirish" %}</a></li>
                <li><a href="#">{% trans "Hududlar" %}</a></li>
                <li><a href="#">{% trans "online.mahalla" %}</a></li>
            </ul>
        </div>
        <div class="footer-map">
            <div class="map-box">
                <iframe src="https://yandex.uz/map-widget/v1/org/123701252573/?ll=69.237650%2C41.311950&z=16"></iframe>
                <div class="map-overlay">
                    <p>{% trans "O'zbekiston Respublikasi, Toshkent shahar, Amir Temur ko'chasi, 12a, uy. 100012" %}</p>
                </div>
            </div>
            <div class="contact-infos">
                <span class="info">+998 71 123 45 67</span>
                <span class="info">poverty@reduction.uz</span>
            </div>
            <div class="social-icons">
                <a href="https://t.me/maqsadlijamgarma"><img src="{% static 'images/logotg.svg' %}" alt="Telegram"></a>
                <a href="https://www.instagram.com/maqsadli_jamgarma/"><img src="{% static 'images/logoinst.svg' %}" alt="Instagram"></a>
                <a href="https://www.youtube.com/@Maqsadljamgarma"><img src="{% static 'images/logoyt.svg' %}" alt="YouTube"></a>
                <a href="https://facebook.com/maqsadlijamgarma"><img src="{% static 'images/logoface.svg' %}" alt="Facebook"></a>
            </div>
        </div>
    </footer>
</main>

<script>
    // CSRF token function
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Language change function
    function changeLanguage(lang) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/i18n/setlang/';
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = getCookie('csrftoken');
        form.appendChild(csrfInput);
        const langInput = document.createElement('input');
        langInput.type = 'hidden';
        langInput.name = 'language';
        langInput.value = lang;
        form.appendChild(langInput);
        const nextInput = document.createElement('input');
        nextInput.type = 'hidden';
        nextInput.name = 'next';
        nextInput.value = window.location.pathname;
        form.appendChild(nextInput);
        document.body.appendChild(form);
        form.submit();
    }

    // Hamburger menu toggle
    const hamburger = document.getElementById('hamburger');
    const mobileMenu = document.getElementById('mobile-menu');
    hamburger.addEventListener('click', function(e) {
        e.stopPropagation();
        hamburger.classList.toggle('active');
        mobileMenu.classList.toggle('active');
    });

    // Language selector dropdown toggle
    const languageSelector = document.getElementById('language-selector');
    languageSelector.addEventListener('click', function(e) {
        e.stopPropagation();
        if (window.innerWidth <= 768) {
            this.classList.toggle('open');
            const arrow = this.querySelector('.arrow-down');
            arrow.style.transform = this.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0deg)';
        }
    });

    // Mobile dropdown for Jang'arma
    const mobileDropdownHeader = document.getElementById('mobile-dropdown-header');
    const mobileDropdownContent = document.getElementById('mobile-dropdown-content');
    mobileDropdownHeader.addEventListener('click', function(e) {
        e.stopPropagation();
        mobileDropdownContent.classList.toggle('active');
        this.classList.toggle('open');
    });

    // Close menus on outside click
    document.addEventListener('click', function(e) {
        if (!hamburger.contains(e.target) && !mobileMenu.contains(e.target)) {
            hamburger.classList.remove('active');
            mobileMenu.classList.remove('active');
        }
        if (!languageSelector.contains(e.target)) {
            languageSelector.classList.remove('open');
            const arrow = languageSelector.querySelector('.arrow-down');
            if (arrow) arrow.style.transform = 'rotate(0deg)';
        }
    });

    // Close mobile menu on link click
    document.querySelectorAll('.mobile-menu a, .mobile-dropdown-content a').forEach(link => {
        link.addEventListener('click', function() {
            hamburger.classList.remove('active');
            mobileMenu.classList.remove('active');
            mobileDropdownContent.classList.remove('active');
            mobileDropdownHeader.classList.remove('open');
        });
    });

    // DOMContentLoaded: Leader & Map logic
    document.addEventListener('DOMContentLoaded', function () {
        function setMapSrc(url) {
            const mapFrame = document.getElementById('region-map');
            if (!mapFrame) return;
            if (!url) {
                mapFrame.removeAttribute('src');
                mapFrame.style.display = 'none';
                const wrapper = mapFrame.parentElement;
                if (wrapper && !wrapper.querySelector('.open-map-link')) {
                    const p = document.createElement('p');
                    p.className = 'open-map-link';
                    p.innerHTML = '<a id="open-map-link" href="#" target="_blank" rel="noopener noreferrer">Открыть на Яндекс.Картах</a>';
                    wrapper.insertBefore(p, mapFrame.nextSibling);
                }
                return;
            }
            const wrapper = mapFrame.parentElement;
            const placeholder = wrapper.querySelector('.open-map-link');
            if (placeholder) placeholder.remove();
            mapFrame.style.display = '';
            mapFrame.src = url;
        }

        function setLeaderInfo(data) {
            const img = document.getElementById('leader-image');
            const nameEl = document.getElementById('leader-name');
            const posEl = document.getElementById('leader-position');
            const mailEl = document.getElementById('leader-mail');
            const phoneEl = document.getElementById('leader-phone');

            if (img && data.image) img.src = data.image;
            if (nameEl) nameEl.textContent = data.name || '';
            if (posEl) posEl.textContent = data.position || '';
            if (mailEl) {
                mailEl.innerHTML = data.mail ? `<a href="mailto:${data.mail}">${data.mail}</a>` : '';
            }
            if (phoneEl) {
                phoneEl.innerHTML = data.phone ? `<a id="leader-phone-a" href="tel:${data.phone}">${data.phone}</a>` : '';
            }

            if (data.regionEmbed) {
                if (data.regionEmbed.includes('map-widget')) {
                    setMapSrc(data.regionEmbed);
                } else {
                    setMapSrc(null);
                    const wrapper = document.getElementById('region-map').parentElement;
                    let link = wrapper.querySelector('.open-map-link');
                    if (!link) {
                        link = document.createElement('p');
                        link.className = 'open-map-link';
                        link.innerHTML = `<a href="${data.regionEmbed}" target="_blank" rel="noopener noreferrer">Открыть на Яндекс.Картах</a>`;
                        wrapper.insertBefore(link, document.getElementById('region-map').nextSibling);
                    } else {
                        link.querySelector('a').href = data.regionEmbed;
                    }
                }
            } else {
                setMapSrc(null);
            }
        }

        // Region button click
        document.querySelectorAll('.region').forEach(btn => {
            btn.addEventListener('click', function () {
                document.querySelectorAll('.region').forEach(b => b.classList.remove('active-region'));
                this.classList.add('active-region');

                const data = {
                    name: this.dataset.name || '',
                    position: this.dataset.position || '',
                    image: this.dataset.image || '',
                    mail: this.dataset.mail || '',
                    phone: this.dataset.phone || '',
                    regionEmbed: this.dataset.regionEmbed || ''
                };
                setLeaderInfo(data);
            });
        });

        // Mobile select change
        const regionSelect = document.getElementById('region-select');
        if (regionSelect) {
            regionSelect.addEventListener('change', function () {
                const opt = this.options[this.selectedIndex];
                const data = {
                    name: opt.dataset.name || '',
                    position: opt.dataset.position || '',
                    image: opt.dataset.image || '',
                    mail: opt.dataset.mail || '',
                    phone: opt.dataset.phone || '',
                    regionEmbed: opt.dataset.regionEmbed || ''
                };
                document.querySelectorAll('.region').forEach(b => {
                    b.classList.toggle('active-region', b.dataset.region === this.value);
                });
                setLeaderInfo(data);
            });
        }

        // Initialize with first leader
        const firstBtn = document.querySelector('.region');
        if (firstBtn) firstBtn.click();
    });
</script>
</body>
</html>